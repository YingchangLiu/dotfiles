#!/usr/bin/env bash

# Define input file and output directory
DOTROOT=${DOTROOT:-$HOME/dotfiles}
input_file="${DOTROOT}/shellrc/functions.sh"
output_dir="${DOTROOT}/bin"

# Create output directory
if [ ! -d "$output_dir" ]; then
    mkdir -p "$output_dir"
fi

# Check if the clean option is passed
if [[ $1 == "--clean" ]]; then
    echo "Removing scripts generated by func2script..."
    while IFS= read -r line; do
        if [[ $line == "#! BEGIN SCRIPT"* ]]; then
            read -r line
            fname=$(echo $line | cut -d' ' -f3)
            output_file="$output_dir/$fname"
            if [ -f "$output_file" ]; then
                rm "$output_file"
                echo "Removed $output_file"
            fi
        fi
    done < "$input_file"
    for file in "$output_dir"/*; do
        if [ -f "$file" ]; then
            # Check if the first three lines of the file contain a specific marker
            if head -n 3 "$file" | grep -q "# This script is autogenerated by func2script"; then
                rm "$file"
                echo "Removed $file"
            fi
        fi
    done

    echo "Removal complete."
    exit 0
fi

# Read the input file
while IFS= read -r line; do
    # Check if it is the beginning of a function
    if [[ $line == "#! BEGIN SCRIPT"* ]]; then
        # Read the function name
        read -r line
        fname=$(echo $line | cut -d' ' -f3)
        output_file="$output_dir/$fname"

        # Initialize variables
        frun_command=""
        function_content=""

        # Read the function content
        read -r line
        function_content+="$line"$'\n'
        while IFS= read -r line && [[ $line != "#! END SCRIPT"* ]]; do
            if [[ $line == "#! FRUN:"* ]]; then
                frun_command=$(echo "$line" | sed 's/#! FRUN: //')
            else
                function_content+="$line"$'\n'
            fi
        done

        # Check if all necessary elements are read
        if [[ -n "$fname" && -n "$function_content" && -n "$frun_command" ]]; then
            # Write to the output file
            echo "#!/usr/bin/env bash" > "$output_file"
            echo "# This script is autogenerated by func2script" >> "$output_file"
            echo "# It is an implementation from $input_file." >> "$output_file"
            echo "" >> "$output_file"
            echo "$function_content" >> "$output_file"
            echo "" >> "$output_file"
            echo "$frun_command" >> "$output_file"

            # Set executable permissions
            chmod +x "$output_file"

            echo "func2script: generated $output_file"

        else
            echo "Missing necessary elements, skipping generation of $fname"
        fi
    fi
done < "$input_file"