#!/usr/bin/env bash

# 定义输入文件和输出目录
DOTROOT=${DOTROOT:-$HOME/dotfiles}
input_file="${DOTROOT}/shellrc/functions.sh"
output_dir="${DOTROOT}/bin"

# 创建输出目录
if [ ! -d "$output_dir" ]; then
    mkdir -p "$output_dir"
fi

# 检查是否传递了删除选项
if [[ $1 == "--clean" ]]; then
    echo "正在删除由 func2script 生成的脚本..."
    while IFS= read -r line; do
        if [[ $line == "#! BEGIN SCRIPT"* ]]; then
            read -r line
            fname=$(echo $line | cut -d' ' -f3)
            output_file="$output_dir/$fname"
            if [ -f "$output_file" ]; then
                rm "$output_file"
                echo "删除 $output_file"
            fi
        fi
    done < "$input_file"
    for file in "$output_dir"/*; do
        if [ -f "$file" ]; then
            # 检查文件的前三行是否包含特定标记
            if head -n 3 "$file" | grep -q "# This script is autogenerated by func2script"; then
                rm "$file"
                echo "删除 $file"
            fi
        fi
    done

    echo "删除完成。"
    exit 0
fi

# 读取输入文件
while IFS= read -r line; do
    # 检查是否是函数的开始
    if [[ $line == "#! BEGIN SCRIPT"* ]]; then
        # 读取函数名
        read -r line
        fname=$(echo $line | cut -d' ' -f3)
        output_file="$output_dir/$fname"

        # 初始化变量
        frun_command=""
        function_content=""

        # 读取函数内容
        read -r line
        function_content+="$line"$'\n'
        while IFS= read -r line && [[ $line != "#! END SCRIPT"* ]]; do
            if [[ $line == "#! FRUN:"* ]]; then
                frun_command=$(echo "$line" | sed 's/#! FRUN: //')
            else
                function_content+="$line"$'\n'
            fi
        done

        # 检查是否读取到所有必要的元素
        if [[ -n "$fname" && -n "$function_content" && -n "$frun_command" ]]; then
            # 写入输出文件
            echo "#!/usr/bin/env bash" > "$output_file"
            echo "# This script is autogenerated by func2script" >> "$output_file"
            echo "# It is an implementation from $input_file." >> "$output_file"
            echo "" >> "$output_file"
            echo "$function_content" >> "$output_file"
            echo "" >> "$output_file"
            echo "$frun_command" >> "$output_file"

            # 设置可执行权限
            chmod +x "$output_file"

            echo "func2script: generated $output_file"

        else
            echo "缺少必要的元素，跳过生成 $fname"
        fi
    fi
done < "$input_file"